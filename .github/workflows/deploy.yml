name: Deploy to Cloudflare Workers

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run diagnostics
        run: node github-workflow-debug.js
        
      - name: Create environment file
        run: |
          echo "JWT_SECRET=${{ secrets.JWT_SECRET || 'default-secret-for-jwt' }}" > .env
          echo "Creating build environment file with JWT_SECRET"
          
      - name: TypeScript Check
        run: npx tsc --noEmit
        continue-on-error: true
          
      - name: Build
        run: |
          echo "Starting build process..."
          npm run build:cloudflare
          echo "Build completed"
          
      - name: Check build output
        run: |
          if [ -d "out" ]; then
            echo "‚úÖ Build output directory 'out' exists"
            ls -la out
          else
            echo "‚ùå Build output directory 'out' is missing"
            exit 1
          fi
          
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          wranglerVersion: '3'
          postCommands: |
            echo "Deployed successfully to Cloudflare Workers at $(date)"
          
      # Optional: Notify about deployment status
      - name: Notify Deployment Status
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: deployments
          SLACK_COLOR: ${{ job.status }}
          SLACK_TITLE: "Mira Booking Deployment"
          SLACK_MESSAGE: "Deployment ${{ job.status }} üöÄ" 